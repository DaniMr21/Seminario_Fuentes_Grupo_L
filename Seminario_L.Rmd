---
title: "Impacto de la vigilancia del aire sobre la fertilidad en la población europea"
author: "Daniel Marina de la Cal, Patricia Ibarrondo Revilla y Nerea Yi Estepar Calvo"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    number_sections: true
---

<center>
<img src="INPUT/IMAGES/portada.png" alt="Gráfico de portada" width="70%">
</center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(readr)
library(readxl)
library(janitor)
library(stringr)
library(scales)
library(lmtest)
library(sandwich)
library(broom)
library(tibble)
library(ggplot2)
library(ggrepel)
```

# Introducción

La fertilidad humana es sensible a condiciones ambientales que afectan tanto a la salud reproductiva como a las decisiones familiares. 

En particular, la calidad del aire se ha relacionado con alteraciones hormonales, inflamación sistémica y estrés oxidativo que pueden reducir la fecundidad, aumentar el riesgo de pérdida gestacional y acortar la ventana fértil. Más allá de los mecanismos biológicos, el entorno en que las familias planifican también responde a expectativas de salud pública, seguridad ambiental y confianza institucional.

En este contexto, la **vigilancia de la calidad del aire** (monitorización sistemática, cobertura de estaciones, reporte y disponibilidad de datos) puede operar como un bien público que mejora la salud y reduce la incertidumbre sobre riesgos ambientales. Una red de vigilancia más densa y activa suele acompañar estrategias de control, cumplimiento normativo y comunicación del riesgo, y puede facilitar políticas de reducción de emisiones. 

El resultado esperado —si estos canales funcionan— es un entorno más saludable y predecible para la crianza, lo que, en teoría, podría favorecer niveles más altos de fertilidad.

Sin embargo, a nivel agregado (país), se conoce menos acerca de:

- Hasta qué punto la intensidad de la vigilancia del aire se asocia con niveles de fertilidad.

- Si la contaminación atmosférica efectiva (por ejemplo, el NO₂ medio) se relaciona con la fertilidad media de los países europeos.

- Si estas relaciones se mantienen una vez que se consideran posibles fuentes de heterogeneidad, como diferencias de tamaño poblacional, urbanización o intensidad de monitorización.

El presente seminario aborda estas cuestiones desde una perspectiva descriptiva, utilizando datos agregados por país para Europa.

# Objetivo general

Analizar la relación entre la vigilancia y la calidad del aire y la fertilidad media (TFR) en los países europeos.

# Objetivos específicos

**Vigilancia vs fertilidad**  
¿Existe asociación entre la intensidad de la vigilancia de la calidad del aire y la fertilidad media (TFR) de los países europeos?

**NO₂ vs fertilidad**  
¿Están los niveles medios de NO₂ en los países europeos relacionados con sus niveles medios de fertilidad (TFR)?

(PONER MAS SEGÚN AVANCEMOS)

# Metodología y resultados:

## Describir la vigilancia de la calidad del aire en Europa

**Pregunta:** ¿Está asociada una mayor vigilancia de la calidad del aire con una mayor fertilidad en la población europea?

**Hipótesis:** Más vigilancia del aire implica más fertilidad.  
Vemos la “vigilancia” mediante el conteo de observaciones de calidad del aire reportadas por país y año; y medimos la fertilidad con la **TFR (Eurostat)**.  

Si la hipótesis es consistente con los datos, esperamos observar una relación **positiva** entre el nivel de vigilancia (más observaciones) y la TFR.

> **Nota:** Esta hipótesis no asume causalidad por sí misma; es un test descriptivo de la asociación.

### Datos y construcción de variables

Trabajamos con dos fuentes principales:

1. **Calidad del aire (`DataExtract.csv`)**:  
   A partir de los registros originales, limpiamos nombres, homogeneizamos países y contamos observaciones por país–año (`n_obs_aire`).  
   Con ello construimos resúmenes por país (por ejemplo, `total_obs_aire` y `años_con_cobertura`).

2. **Fertilidad (Eurostat, anual) (`Fertilidad.csv`)**:  
   Extraemos la **TFR** por país–año, homogeneizamos códigos `geo` a nombres de país y calculamos resúmenes (por ejemplo, `tfr_mean` por país).

### Pipeline de trabajo

1. **Limpieza y homogeneización** de ambas tablas, incluyendo nombres de países.  
2. **Conteo de vigilancia:** `aire_conteo` (país, año, `n_obs_aire`).  
3. **Resumen de fertilidad:** `fert_resumen_nombres` (estadísticos por país).  
4. **Joins:**
   - `panel_aire_year_con_fert`: panel país–año con resumen de fertilidad adjunto.  
   - `resumen_aire_fert_pais`: resumen combinado por país, utilizado para el **gráfico de dispersión**.  
5. **Control de calidad:** detección de países sin coincidencia entre tablas.


### Estrategia empírica y lectura de resultados

Como primer **“test”**, graficamos `tfr_mean` (eje *x*) frente a `total_obs_aire` (eje *y*) por país y ajustamos una **recta OLS** con su **banda de confianza**.  

Este gráfico nos permite explorar de forma descriptiva si existe una **asociación positiva** entre la intensidad de vigilancia del aire y la fertilidad promedio en cada país.


```{r codigografico1, include = FALSE}

#-------------------------------------------------------------------------------
# Lectura

aire <- read_delim(
  "INPUT/DATA/DataExtract.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

fertilidad <- read_delim(
  "INPUT/DATA/Fertilidad.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

# (Opcional; no se usa abajo, pero lo leo por si lo necesitas)
modelos <- read_delim(
  "INPUT/DATA/Models and objetive.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

#-------------------------------------------------------------------------------
# Limpieza básica

aire       <- clean_names(aire)
fertilidad <- clean_names(fertilidad)


#-------------------------------------------------------------------------------
# FERTILIDAD (Eurostat): anual con códigos -> nombres país

# Mantener 'geo' como código y luego mapear a 'country'
fert_codes <- fertilidad |>
  filter(freq == "A") |>
  transmute(
    geo  = geo,                         # código Eurostat
    year = as.integer(time_period),
    tfr  = as.numeric(obs_value)
  )

# Mapeo de códigos Eurostat -> nombre país
fert_paises <- fert_codes |>
  mutate(country = case_when(
    geo == "AD" ~ "Andorra",
    geo == "AL" ~ "Albania",
    geo == "AM" ~ "Armenia",
    geo == "AT" ~ "Austria",
    geo == "AZ" ~ "Azerbaijan",
    geo == "BA" ~ "Bosnia and Herzegovina",
    geo == "BE" ~ "Belgium",
    geo == "BG" ~ "Bulgaria",
    geo == "BY" ~ "Belarus",
    geo == "CH" ~ "Switzerland",
    geo == "CY" ~ "Cyprus",
    geo == "CZ" ~ "Czechia",                  # usa "Czech Republic" si así sale en 'aire'
    geo == "DE" ~ "Germany",
    geo == "DK" ~ "Denmark",
    geo == "EE" ~ "Estonia",
    geo == "EL" ~ "Greece",                   # EL = Greece
    geo == "ES" ~ "Spain",
    geo == "FI" ~ "Finland",
    geo == "FR" ~ "France",
    geo == "GE" ~ "Georgia",
    geo == "GI" ~ "Gibraltar",
    geo == "HR" ~ "Croatia",
    geo == "HU" ~ "Hungary",
    geo == "IE" ~ "Ireland",
    geo == "IS" ~ "Iceland",
    geo == "IT" ~ "Italy",
    geo == "LI" ~ "Liechtenstein",
    geo == "LT" ~ "Lithuania",
    geo == "LU" ~ "Luxembourg",
    geo == "LV" ~ "Latvia",
    geo == "MC" ~ "Monaco",
    geo == "MD" ~ "Moldova",
    geo == "ME" ~ "Montenegro",
    geo == "MK" ~ "North Macedonia",
    geo == "MT" ~ "Malta",
    geo == "NL" ~ "Netherlands",
    geo == "NO" ~ "Norway",
    geo == "PL" ~ "Poland",
    geo == "PT" ~ "Portugal",
    geo == "RO" ~ "Romania",
    geo == "RS" ~ "Serbia",
    geo == "RU" ~ "Russia",
    geo == "SE" ~ "Sweden",
    geo == "SI" ~ "Slovenia",
    geo == "SK" ~ "Slovakia",
    geo == "SM" ~ "San Marino",
    geo == "TR" ~ "Türkiye",    # si 'aire' usa "Turkey", abajo lo homogeneizamos
    geo == "UA" ~ "Ukraine",
    geo == "UK" ~ "United Kingdom",
    geo == "VA" ~ "Vatican City",
    geo == "XK" ~ "Kosovo",
    # Agregados (no países) -> fuera del join
    geo %in% c("EU27_2020","EU27","EU28","EA19","EFTA") ~ NA_character_
  )) |>
  filter(!is.na(country)) |>
  select(country, year, tfr)

#-------------------------------------------------------------------------------
# AIRE: conteo por país-año
# Normalizo nombres y tipos; además, homogeneizo algunos alias típicos
aire_conteo <- aire |>
  mutate(
    country = str_trim(country),
    year    = as.integer(year),
    # Homogeneización de alias frecuentes (solo se aplica si existen)
    country = recode(country,
                     "Turkey" = "Türkiye",
                     "Czech Republic" = "Czechia",
                     "Russian Federation" = "Russia",
                     "Republic of Moldova" = "Moldova",
                     "UK" = "United Kingdom",
                     "Great Britain" = "United Kingdom"
    )
  ) |>
  count(country, year, name = "n_obs_aire") |>
  arrange(country, year)

write_csv(aire_conteo, "OUTPUT/DATA/aire_conteo_country_year.csv")

#-------------------------------------------------------------------------------
# Resumen de fertilidad por país (nombres ya homogeneizados)

fert_resumen_nombres <- fert_paises |>
  group_by(country) |>
  summarise(
    n_years  = n(),
    year_min = min(year, na.rm = TRUE),
    year_max = max(year, na.rm = TRUE),
    tfr_mean = mean(tfr, na.rm = TRUE),
    tfr_min  = min(tfr, na.rm = TRUE),
    tfr_max  = max(tfr, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(country)

#-------------------------------------------------------------------------------
# JOINS SOLICITADOS

# A) Panel país–año con resumen de fertilidad adjunto (join por country)
panel_aire_year_con_fert <- aire_conteo |>
  left_join(fert_resumen_nombres, by = "country")

# B) Resumen por país: agregamos aire y fertilidad
aire_resumen_pais <- aire_conteo |>
  group_by(country) |>
  summarise(
    n_years_aire     = n_distinct(year),
    year_min_aire    = min(year, na.rm = TRUE),
    year_max_aire    = max(year, na.rm = TRUE),
    total_obs_aire   = sum(n_obs_aire, na.rm = TRUE),
    avg_obs_por_year = mean(n_obs_aire, na.rm = TRUE),
    .groups = "drop"
  )

resumen_aire_fert_pais <- aire_resumen_pais |>
  full_join(fert_resumen_nombres, by = "country") |>
  arrange(country)


# C) Promedios de fertilidad usando solo años que existen en 'aire_conteo' (solapamiento)
fert_resumen_overlap <- fert_paises |>
  semi_join(aire_conteo |> distinct(country, year), by = c("country","year")) |>
  group_by(country) |>
  summarise(
    n_years_ovlp  = n(),
    year_min_ovlp = min(year, na.rm = TRUE),
    year_max_ovlp = max(year, na.rm = TRUE),
    tfr_mean_ovlp = mean(tfr, na.rm = TRUE),
    .groups = "drop"
  )

resumen_aire_fert_overlap <- aire_resumen_pais |>
  full_join(fert_resumen_overlap, by = "country") |>
  arrange(country)

write_csv(resumen_aire_fert_overlap,
          "OUTPUT/DATA/resumen_aire_fert_pais_overlap.csv")

# QC de nombres que no machéan

faltan_en_fert <- aire_conteo |> distinct(country) |>
  anti_join(fert_resumen_nombres |> distinct(country), by = "country")
faltan_en_aire <- fert_resumen_nombres |> distinct(country) |>
  anti_join(aire_conteo |> distinct(country), by = "country")

#print(faltan_en_fert)
#print(faltan_en_aire)

# Muestras rápidas
#print(head(aire_conteo, 10))
#print(head(fert_resumen_nombres, 10))
#print(head(resumen_aire_fert_pais, 10))

```

```{r grafico1, echo=FALSE, fig.width=8, fig.height=6}

#-------------------------------------------------------------------------------
#Gráfico 

resumen_aire_fert_pais%>%
  filter(!is.na(tfr_mean), !is.na(total_obs_aire)) %>%
  ggplot(aes(x = tfr_mean, y = total_obs_aire)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Observaciones de aire vs TFR medio (por país)",
    x = "TFR medio",
    y = "Observaciones de aire (total)"
  ) +
  theme_minimal()

```

### Resultados:

El diagrama de dispersión entre `total_obs_aire` (y) y `tfr_mean` (x) con una recta OLS sugiere que, a grandes rasgos, la asociación es como mucho débil y sensible a *outliers*. Visualmente, la pendiente no parece fuertemente positiva y la banda de confianza cubre valores cercanos a cero en buena parte del rango de `tfr_mean`.

El eje Y (conteos absolutos) probablemente está afectado por tamaño poblacional, densidad urbana y número de estaciones; no es una “intensidad de vigilancia” comparable *per cápita*.

**Lectura honesta.**  
Con este primer gráfico no podemos afirmar que “más vigilancia implica más fertilidad”. Si existe relación, no es grande y podría estar mediada por terceros factores (riqueza, contaminación, urbanización, gasto sanitario, políticas familiares, etc.).

A continuación vamos a realizar los lest estadísticos de Pearson y Spearman para demostrar esto de manera más objetiva:

```{r test1, echo=FALSE}
library(lmtest)
library(sandwich)
library(broom)
library(tibble)

df_test <- resumen_aire_fert_pais %>%
filter(!is.na(tfr_mean), !is.na(total_obs_aire)) %>%
mutate(
y_log = log1p(total_obs_aire) # estabiliza varianza ante colas largas
)

#Correlaciones

cor_pearson <- cor.test(df_test$tfr_mean, df_test$y_log, method = "pearson")
cor_spearman <- cor.test(df_test$tfr_mean, df_test$y_log, method = "spearman", exact = FALSE)

# Empaquetado de resultados clave

resumen <- tibble(
indicador = c("Correlación Pearson (r)", "p-valor Pearson",
"Correlación Spearman (rho)", "p-valor Spearman"),
valor = c(
round(unname(cor_pearson$estimate), 3),
signif(cor_pearson$p.value, 3),
round(unname(cor_spearman$estimate), 3),
signif(cor_spearman$p.value, 3)))

knitr::kable(resumen, caption = "Tests estadísticos")

```

Los resultados del test confirman la lectura visual del gráfico:

**Correlación de Pearson (r = 0.017, p = 0.92)** -> no existe relación lineal entre la fertilidad media y el nivel total de observaciones de calidad del aire.  

**Correlación de Spearman (ρ = 0.026, p = 0.877)** -> tampoco se observa relación monótona, es decir, los países con más vigilancia no presentan  mayor ni menor fertilidad.  

Ambos *p-valores* son muy superiores al umbral convencional de 0.05, lo que implica que no hay evidencia estadísticamente significativa de asociación entre ambas variables.  

En términos sencillos, la intensidad de vigilancia del aire no parece explicar las diferencias de fertilidad entre países europeos. Esto sugiere que la hipótesis naïf (“más vigilancia → más fertilidad”) no se sostiene empíricamente en el corte transversal.

## Caracterizar la fertilidad media de los países europeos

En esta segunda parte ampliamos el análisis pasando de la “vigilancia del aire” a la calidad del aire en sí, centrándonos en un contaminante clave: el dióxido de nitrógeno (NO₂). Este compuesto es un marcador típico de tráfico rodado y combustión urbana, y se ha vinculado con diversos efectos adversos para la salud, incluidos riesgos durante el embarazo y potenciales impactos en la salud reproductiva.

**Pregunta:**  
¿Existe una relación entre los niveles medios de NO₂ en cada país europeo y su fertilidad media?

**Hipótesis:**  
Esperamos observar una relación **negativa**: países con mayor NO₂ medio deberían presentar, en promedio, niveles más bajos de fertilidad.  

Como antes, esta hipótesis es descriptiva, no causal; buscamos el signo de la asociación en los datos agregados.

### Datos y construcción de variables

Para esta sección combinamos dos fuentes principales:

1. **OMS — AAP 2022 (`OMS_Datos.xlsx`)**  
   - Filtramos únicamente los países pertenecientes a la *European Region*.  
   - Extraemos los valores de NO₂ por ciudad (`NO2 (μg/m3)`).  
   - Armonizamos los nombres de país (e.g., *Turkey → Türkiye*, *Russian Federation → Russia*).

2. **Eurostat — Fertilidad (`fert_resumen_nombres`)**  
   - Contiene la TFR media por país, ya homogeneizada en la Parte 1.

Tras armonizar y unir ambas tablas mediante un `left_join()`, obtenemos un panel ciudad–año con valores de NO₂ y fertilidad media por país.  
A partir de ese panel construimos un **resumen por país** con las siguientes variables:

- `no2_mean`: media del NO₂ por país.  
- `no2_median`: mediana de NO₂.  
- `n_cities`: número de ciudades o localidades monitorizadas.  
- `tfr_mean`: fertilidad media (Eurostat).  

Este resumen nos permite trabajar con una unidad clara (el país) y explorar la relación entre contaminación y fertilidad.

### Estrategia empírica

Para visualizar la relación NO₂–fertilidad utilizamos un **gráfico de burbujas**:

- **Eje X:** concentración media de NO₂ por país.  
- **Eje Y:** fertilidad media (TFR).  
- **Tamaño del punto:** número de ciudades monitorizadas (`n_cities`).  
- **Etiqueta:** nombre del país.  
- **Recta OLS:** ajustada con banda de confianza (estimación visual del signo de la asociación).

Este enfoque es informativo porque combina:
- diferencias en contaminación,  
- diferencias en fertilidad,  
- y diferencias en la intensidad de monitorización entre países.

### Resultados

```{r pregunta2_codigos, echo=FALSE}
# Leer directamente desde la hoja principal
oms <- read_excel("INPUT/DATA/OMS_Datos.xlsx", sheet = "AAP_2022_city_v9")

# 1.solo Europa
oms_europa <- oms %>%
  filter(`WHO Region` == "European Region")

# 2.variable 'country' con nombres armonizados
oms_europa_limpio <- oms_europa %>%
  mutate(
    country = str_trim(`WHO Country Name`),
    country = recode(
      country,
      "Turkey"             = "Türkiye",
      "Russian Federation" = "Russia",
      "Republic of Moldova" = "Moldova"
    )
  )

# 3. JOIN: tabla OMS (ciudad-año) + resumen de fertilidad por país
oms_europa_con_fert <- oms_europa_limpio %>%
  left_join(fert_resumen_nombres, by = "country")

# Opcional: mirar qué países de OMS no tienen fertilidad
faltan_fert_oms <- oms_europa_limpio %>%
  distinct(country) %>%
  anti_join(fert_resumen_nombres %>% distinct(country), by = "country")

pais_no2_fert <- oms_europa_con_fert %>%
  group_by(country) %>%
  summarise(
    no2_mean   = mean(`NO2 (μg/m3)`, na.rm = TRUE),
    no2_median = median(`NO2 (μg/m3)`, na.rm = TRUE),
    n_cities   = n_distinct(`City or Locality`),
    tfr_mean   = first(tfr_mean),   # viene del resumen de fertilidad
    .groups = "drop"
  ) %>%
  filter(!is.na(no2_mean), !is.na(tfr_mean))

```

```{r grafico2, echo=FALSE, fig.width=8, fig.height=6}
library(ggplot2)
library(ggrepel)

ggplot(pais_no2_fert,
       aes(x = no2_mean,
           y = tfr_mean,
           size = n_cities)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  geom_text_repel(aes(label = country),
                  size = 3,
                  max.overlaps = 30) +
  scale_size_continuous(name = "Nº de ciudades\nmonitorizadas") +
  labs(
    title = "NO2 medio vs fertilidad media por país europeo",
    subtitle = "Tamaño del punto = nº de ciudades con datos de NO₂",
    x = "NO2 medio (µg/m^3, OMS)",
    y = "TFR medio (Eurostat)"
  ) +
  theme_minimal()
```

El gráfico revela una estructura altamente dispersa:

- Los países con NO₂ alto no se concentran especialmente en la parte baja del eje de fertilidad.  
- Varios países muy contaminados (*Turquía* o *Italia*) exhiben fertilidades relativamente bajas, pero otros no.  
- La recta de regresión muestra una pendiente casi plana, con una banda de confianza amplia que incluye valores cercanos a cero en la mayor parte del rango.

En otras palabras:  
no se aprecia evidencia de que mayores niveles medios de NO₂ estén sistemáticamente asociados con menores niveles de fertilidad en Europa.

Esto es coherente con la lectura de la Parte 1:  
el vínculo entre contaminación atmosférica y natalidad, si existe, parece débil a nivel agregado y probablemente mediado por múltiples factores (urbanización, edad materna, políticas familiares, estructura económica, densidad poblacional, etc.).

Aunque los efectos biológicos del NO₂ sobre la reproducción han sido documentados en estudios clínicos y epidemiológicos, estos pueden quedar enmascarados por la heterogeneidad interna de cada país y por la diferencia entre contaminación urbana y fertilidad nacional promedio.

# Conclusiones

No poner nada hasta haber terminado todos los objetivos específicos

# Referencias

Eurostat. (s. f.). Fertility statistics (TFR by country and year). Oficina de Estadística de la Unión Europea.

World Health Organization. (2022). Ambient Air Pollution Database (AAP 2022). WHO, Department of Environment, Climate Change and Health.

Carré, J., Gatimel, N., Moreau, J., Parinaud, J., & Léandri, R. (2017). Does air pollution play a role in infertility? A systematic review. Environmental Health, 16(1), 82.

Landrigan, P. J., Fuller, R., Acosta, N. J. R., et al. (2018). The Lancet Commission on pollution and health. The Lancet, 391(10119), 462–512.

WHO. (2021). WHO global air quality guidelines: Particulate matter (PM₂.₅ and PM₁₀), ozone, nitrogen dioxide, sulfur dioxide and carbon monoxide. World Health Organization.