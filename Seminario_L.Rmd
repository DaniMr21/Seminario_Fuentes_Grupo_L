---
title: "Impacto de la vigilancia del aire sobre la fertilidad en la población europea"
author: "Daniel Marina de la Cal, Patricia Ibarrondo Revilla y Nerea Yi Estepar Calvo"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    number_sections: true
---

## Introducción

La fertilidad humana es sensible a condiciones ambientales que afectan tanto a la salud reproductiva como a las decisiones familiares. 
En particular, la calidad del aire se ha relacionado con alteraciones hormonales, inflamación sistémica y estrés oxidativo que pueden reducir la fecundidad, aumentar el riesgo de pérdida gestacional y acortar la ventana fértil. Más allá de los mecanismos biológicos, el entorno en que las familias planifican también responde a expectativas de salud pública, seguridad ambiental y confianza institucional.

En ese contexto, la **vigilancia de la calidad del aire** (monitorización sistemática, cobertura de estaciones, reporte y disponibilidad de datos) puede operar como un bien público que mejora la salud y reduce la incertidumbre sobre riesgos ambientales. Una red de vigilancia más densa y activa suele acompañar estrategias de control, cumplimiento normativo y comunicación del riesgo, y puede facilitar políticas de reducción de emisiones. 
El resultado esperado —si estos canales funcionan— es un entorno más saludable y predecible para la crianza, lo que, en teoría, podría favorecer niveles más altos de fertilidad.

## Pregunta e hipótesis

**Pregunta:** ¿Está asociada una mayor vigilancia de la calidad del aire con una mayor fertilidad en la población europea?

**Hipótesis (naïf/observacional):** Más vigilancia del aire implica más fertilidad.  
Operacionalizamos “vigilancia” mediante el conteo de observaciones de calidad del aire reportadas por país y año; y medimos la fertilidad con la **TFR (Eurostat)**.  

Si la hipótesis es consistente con los datos, esperamos observar una relación **positiva** entre el nivel de vigilancia (más observaciones) y la TFR.

> **Nota:** Esta hipótesis no asume causalidad por sí misma; es un test descriptivo del signo de la asociación.

## Datos y construcción de variables

Trabajamos con dos fuentes principales:

1. **Calidad del aire (`DataExtract.csv`)**:  
   A partir de los registros originales, limpiamos nombres, homogeneizamos países y contamos observaciones por país–año (`n_obs_aire`).  
   Con ello construimos resúmenes por país (por ejemplo, `total_obs_aire` y `años_con_cobertura`).

2. **Fertilidad (Eurostat, anual) (`Fertilidad.csv`)**:  
   Extraemos la **TFR** por país–año, homogeneizamos códigos `geo` a nombres de país y calculamos resúmenes (por ejemplo, `tfr_mean` por país).

### Pipeline de trabajo

1. **Limpieza y homogeneización** de ambas tablas, incluyendo nombres de países.  
2. **Conteo de vigilancia:** `aire_conteo` (país, año, `n_obs_aire`).  
3. **Resumen de fertilidad:** `fert_resumen_nombres` (estadísticos por país).  
4. **Joins:**
   - `panel_aire_year_con_fert`: panel país–año con resumen de fertilidad adjunto.  
   - `resumen_aire_fert_pais`: resumen combinado por país, utilizado para el **gráfico de dispersión**.  
5. **Control de calidad:** detección de países sin coincidencia entre tablas.


## Estrategia empírica y lectura de resultados

Como primer **“test de olor”**, graficamos `tfr_mean` (eje *x*) frente a `total_obs_aire` (eje *y*) por país y ajustamos una **recta OLS** con su **banda de confianza**.  

Este gráfico nos permite explorar de forma descriptiva si existe una **asociación positiva** entre la intensidad de vigilancia del aire y la fertilidad promedio en cada país.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(readr)
library(janitor)
library(stringr)
library(scales)
```

```{r setup, include=FALSE}

#-------------------------------------------------------------------------------
# Lectura

aire <- read_delim(
  "INPUT/DATA/DataExtract.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

fertilidad <- read_delim(
  "INPUT/DATA/Fertilidad.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

# (Opcional; no se usa abajo, pero lo leo por si lo necesitas)
modelos <- read_delim(
  "INPUT/DATA/Models and objetive.csv",
  delim = ",", escape_double = FALSE, trim_ws = TRUE
)

#-------------------------------------------------------------------------------
# Limpieza básica

aire       <- clean_names(aire)
fertilidad <- clean_names(fertilidad)


#-------------------------------------------------------------------------------
# FERTILIDAD (Eurostat): anual con códigos -> nombres país

# Mantener 'geo' como código y luego mapear a 'country'
fert_codes <- fertilidad |>
  filter(freq == "A") |>
  transmute(
    geo  = geo,                         # código Eurostat
    year = as.integer(time_period),
    tfr  = as.numeric(obs_value)
  )

# Mapeo de códigos Eurostat -> nombre país
fert_xwalk <- fert_codes |>
  mutate(country = case_when(
    geo == "AD" ~ "Andorra",
    geo == "AL" ~ "Albania",
    geo == "AM" ~ "Armenia",
    geo == "AT" ~ "Austria",
    geo == "AZ" ~ "Azerbaijan",
    geo == "BA" ~ "Bosnia and Herzegovina",
    geo == "BE" ~ "Belgium",
    geo == "BG" ~ "Bulgaria",
    geo == "BY" ~ "Belarus",
    geo == "CH" ~ "Switzerland",
    geo == "CY" ~ "Cyprus",
    geo == "CZ" ~ "Czechia",                  # usa "Czech Republic" si así sale en 'aire'
    geo == "DE" ~ "Germany",
    geo == "DK" ~ "Denmark",
    geo == "EE" ~ "Estonia",
    geo == "EL" ~ "Greece",                   # EL = Greece
    geo == "ES" ~ "Spain",
    geo == "FI" ~ "Finland",
    geo == "FR" ~ "France",
    geo == "GE" ~ "Georgia",
    geo == "GI" ~ "Gibraltar",
    geo == "HR" ~ "Croatia",
    geo == "HU" ~ "Hungary",
    geo == "IE" ~ "Ireland",
    geo == "IS" ~ "Iceland",
    geo == "IT" ~ "Italy",
    geo == "LI" ~ "Liechtenstein",
    geo == "LT" ~ "Lithuania",
    geo == "LU" ~ "Luxembourg",
    geo == "LV" ~ "Latvia",
    geo == "MC" ~ "Monaco",
    geo == "MD" ~ "Moldova",
    geo == "ME" ~ "Montenegro",
    geo == "MK" ~ "North Macedonia",
    geo == "MT" ~ "Malta",
    geo == "NL" ~ "Netherlands",
    geo == "NO" ~ "Norway",
    geo == "PL" ~ "Poland",
    geo == "PT" ~ "Portugal",
    geo == "RO" ~ "Romania",
    geo == "RS" ~ "Serbia",
    geo == "RU" ~ "Russia",
    geo == "SE" ~ "Sweden",
    geo == "SI" ~ "Slovenia",
    geo == "SK" ~ "Slovakia",
    geo == "SM" ~ "San Marino",
    geo == "TR" ~ "Türkiye",    # si 'aire' usa "Turkey", abajo lo homogeneizamos
    geo == "UA" ~ "Ukraine",
    geo == "UK" ~ "United Kingdom",
    geo == "VA" ~ "Vatican City",
    geo == "XK" ~ "Kosovo",
    # Agregados (no países) -> fuera del join
    geo %in% c("EU27_2020","EU27","EU28","EA19","EFTA") ~ NA_character_
  )) |>
  filter(!is.na(country)) |>
  select(country, year, tfr)

#-------------------------------------------------------------------------------
# AIRE: conteo por país-año
# Normalizo nombres y tipos; además, homogeneizo algunos alias típicos
aire_conteo <- aire |>
  mutate(
    country = str_trim(country),
    year    = as.integer(year),
    # Homogeneización de alias frecuentes (solo se aplica si existen)
    country = recode(country,
                     "Turkey" = "Türkiye",
                     "Czech Republic" = "Czechia",
                     "Russian Federation" = "Russia",
                     "Republic of Moldova" = "Moldova",
                     "UK" = "United Kingdom",
                     "Great Britain" = "United Kingdom"
    )
  ) |>
  count(country, year, name = "n_obs_aire") |>
  arrange(country, year)

write_csv(aire_conteo, "OUTPUT/DATA/aire_conteo_country_year.csv")

#-------------------------------------------------------------------------------
# Resumen de fertilidad por país (nombres ya homogeneizados)

fert_resumen_nombres <- fert_xwalk |>
  group_by(country) |>
  summarise(
    n_years  = n(),
    year_min = min(year, na.rm = TRUE),
    year_max = max(year, na.rm = TRUE),
    tfr_mean = mean(tfr, na.rm = TRUE),
    tfr_min  = min(tfr, na.rm = TRUE),
    tfr_max  = max(tfr, na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(country)

write_csv(fert_resumen_nombres, "OUTPUT/DATA/fert_resumen_por_pais.csv")

#-------------------------------------------------------------------------------
# JOINS SOLICITADOS

# A) Panel país–año con resumen de fertilidad adjunto (join por country)
panel_aire_year_con_fert <- aire_conteo |>
  left_join(fert_resumen_nombres, by = "country")

write_csv(panel_aire_year_con_fert,
          "OUTPUT/DATA/panel_aire_year_con_fert_resumen.csv")

# B) Resumen por país: agregamos aire y fertilidad
aire_resumen_pais <- aire_conteo |>
  group_by(country) |>
  summarise(
    n_years_aire     = n_distinct(year),
    year_min_aire    = min(year, na.rm = TRUE),
    year_max_aire    = max(year, na.rm = TRUE),
    total_obs_aire   = sum(n_obs_aire, na.rm = TRUE),
    avg_obs_por_year = mean(n_obs_aire, na.rm = TRUE),
    .groups = "drop"
  )

resumen_aire_fert_pais <- aire_resumen_pais |>
  full_join(fert_resumen_nombres, by = "country") |>
  arrange(country)

write_csv(resumen_aire_fert_pais,
          "OUTPUT/DATA/resumen_aire_fert_pais.csv")

# C) Promedios de TFR usando solo años que existen en 'aire_conteo' (solapamiento)
fert_resumen_overlap <- fert_xwalk |>
  semi_join(aire_conteo |> distinct(country, year), by = c("country","year")) |>
  group_by(country) |>
  summarise(
    n_years_ovlp  = n(),
    year_min_ovlp = min(year, na.rm = TRUE),
    year_max_ovlp = max(year, na.rm = TRUE),
    tfr_mean_ovlp = mean(tfr, na.rm = TRUE),
    .groups = "drop"
  )

resumen_aire_fert_ovlp <- aire_resumen_pais |>
  full_join(fert_resumen_overlap, by = "country") |>
  arrange(country)

write_csv(resumen_aire_fert_ovlp,
          "OUTPUT/DATA/resumen_aire_fert_pais_overlap.csv")

# QC de nombres que no machéan

faltan_en_fert <- aire_conteo |> distinct(country) |>
  anti_join(fert_resumen_nombres |> distinct(country), by = "country")
faltan_en_aire <- fert_resumen_nombres |> distinct(country) |>
  anti_join(aire_conteo |> distinct(country), by = "country")

print(faltan_en_fert)
print(faltan_en_aire)

# Muestras rápidas
print(head(aire_conteo, 10))
print(head(fert_resumen_nombres, 10))
print(head(resumen_aire_fert_pais, 10))

#-------------------------------------------------------------------------------
#Gráfico 

resumen_aire_fert_pais %>%
  filter(!is.na(tfr_mean), !is.na(total_obs_aire)) %>%
  ggplot(aes(x = tfr_mean, y = total_obs_aire)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(
    title = "Observaciones de aire vs TFR medio (por país)",
    x = "TFR medio",
    y = "Observaciones de aire (total)"
  ) +
  theme_minimal()

```



